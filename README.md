# 基于物理的渲染(Physically Based Rendering)原理
**基于物理渲染**假设平面由大量微平面构成，满足基本物理定理比如能量守恒。
- 微平面模型：达到微光尺度任何平面都微分成微平面(细小镜面-光学平面，远大于光的波长又远小于单个像素覆盖区域)，根据粗糙程度的不同，越粗糙这些微平面的排列越混乱造成入射光线向不同方向发散的分布范围广泛的镜面反射效果，反之造成更细小锐利的效果，宏观视角下平面朝多方向反射折射
>[!TIP]
>也就是说假设非光学平面是大量微型光学平面的集合
- 粗糙度：基于统计，平面微平面的法线和半程向量一致的比例，越高越粗糙
- 能量守恒：出射光线能量永远不能超过入射光线能量，因为更粗糙的表面有更广泛的镜面反射，如果每个像素的镜面反射强度一样，粗糙平面就会反射更多的能量违反能量守恒，除此以外还需要满足互易性因为光路可逆向交换入射方向和出射方向方程任然成立。

根据以上讨论我们使用以下渲染方程计算光照。  
**渲染方程：**
```math
  L_o(p,\omega_o) = \int_\Omega f_r(p,\omega_i,\omega_o)L_i(p,\omega_i)n⋅\omega_i d\omega_i 
```
>[!tip]
>表示在$`\omega_o`$方向上观察，半球领域Ω所有入射光线投射到点p上反射出来的辐射亮度$`L_o`$,乘以$`n⋅\omega_i`$表示光线的入射方向$`\omega_i`$在宏观法线 𝑛上的投影强度才会对表面贡献反射辐射亮度

光线碰撞到表面时，它会分离成折射部分和反射部分，折射部分又在物体内部碰撞随机发散(要么碰撞耗尽要么再次离开表面)，如果考虑发射出去的折射光就是**次表面散射**，金属表面和电介质不同会完全吸收折射部分被自由电子吸收
因此电介质和金属的渲染方程有所不同。金属只需要计算镜面反射。
- 镜面部分反射率：
  - 非金属的反射率 F0 是固定值（基于典型折射率，如 1.5）,非金属颜色由**漫反射**(次表面散射)的反射率$`\rho`$决定且镜面反射较弱。  
  - 金属的反射率 F0 直接由艺术家指定的颜色（materialColour.rgb）决定。因为金属要么反射要么完全吸收没有漫反射，对不同波长有不同的反射率，金属颜色由镜面反射率决定

电介质还需要计算漫反射，漫反射的“随机方向散射”本质上是由次表面散射的多次碰撞造成的。在渲染中使用简化的漫反射或次表面散射模型取决于**次表面入射点-出射点距离**相对像素点覆盖区域，像素大于**次表面入射点-出射点距离**就可以将着色看作局部过程：某点出射光取决于同一点入射光，所以远距离一般用漫反射，近距离用次表面散射。
>[!tip]
>金属会立即吸收折射光，能量被自由电子吸收，复折射率的虚部极高

根据光源的不同我们将分成以下几种光照模式：
- 面光源：具有几何形状面积的光源，光从表面每个点发出，具有柔和阴影，渲染中需要对光源面积积分考虑每个点的辐射亮度和几何关系
- 点光源：对于渲染片段点光源的影响仅由两个量定义，光源颜色和光线方向，光源颜色通常定义为理想化表面的反射辐射度，这样极小面光源渲染方程通过这个定义代换成点光源颜色就可以简化积分为单次BRDF计算
- 环境光照：低频照明的数值化表示(平滑过渡的周围环境光)，涵盖从单一恒定的入射光色强度到球谐函数(SH)等复杂形式
>[!tip]
>低频照明指的是光照分布的空间频率较低，即光照强度在不同方向上的变化较为平滑，高频光照指光照分布变化剧烈的光源

- 通用光照：BRDF需对所有方向入射光进行积分计算包括太阳光以及场景其它物体反射光，完整求解需要蒙特卡洛光线追踪(全局光照算法)
- 基于图像光照(IBL)：将周围场景光照存储为环境贴图，各个方向的入射光辐射强度通过对环境光照采样得到用于配合BRDF光照计算
>[!tip]
>该环境贴图一般为HDR，高色域且线性存储(没有gamma映射)，通过等距柱状投影将球面映射到长方形，本质就是按经纬度方向弧长等距映射到柱面x,y轴上(无投影)

项目代码中仅用到了点光源和IBL，**基于图像光照将用到以下方法**
1. 分割求和近似法：epic公司所应用的近似方法，将镜面光照的积分分成两部分积分再乘起来。一部分对环境光照贴图积分余弦加权存储为立方体预滤波贴图，另一部分对brdf项积分作为一个综合过滤器存储为2D查找表
2. 环境贴图预滤波（Environment Map Prefiltering）:预计算不同粗糙度在BRDF特性下的光照效果(环境贴图按BRDF的镜面项或漫反射项进行卷积)，生成一组简化贴图，实时渲染只需采样贴图提高了效率
3. 重要性采样：根据BRDF或环境贴图的特性，优先采样那些对结果贡献大的方向，并减少采样次数，这样可以减少蒙特卡洛积分的方差，渲染结果更加平滑减少了噪声，比如采样概率密度函数和法线分布函数成正比(因为法线分布函数衡量了不同入射方向对反射方向的贡献程度),实际上就是按照某一概率密度函数生成对应的采样样本，以这些样本进行蒙特卡洛积分-有偏概率估计
## 双向反射分布函数（BRDF, Bidirectional Reflectance Distribution Function）
- 双向反射分布函数（BRDF, Bidirectional Reflectance Distribution Function）:$`f_r=k_d f_{lambert} + k_s f_{cook−torrance}`$，对于给定出射（视线）方向，它指定每个方向的入射光([辐射强度](Radiant-Intensity))对出射光([辐射亮度](Radiance))的相对贡献，定义为出射辐射亮度与入射辐射强度的比值
>这里渲染方程分为多重反弹次表面散射(漫反射项)和单次反弹表面反射(镜面反射项)
### 漫反射部分
- Lambert BRDF(介电质的漫反射部分)： $`f_r(p,\omega_i,\omega_o) = \frac{\rho}{\pi}`$, 表示所有入射的辐射亮度(无论角度)经过该常数缩放后都会贡献到ωo反射的辐射亮度,$`\rho`$是表面的漫反射反照率

我们将其带入渲染方程并转换成球坐标：
```math
 L_o(p,\omega_o) = \frac{\rho}{\pi} \int_\Omega L_i(p,\omega_i)(n⋅\omega_i)d\omega_i = L_0(p,\theta_o,\phi_o) = \frac{\rho}{\pi}\int_0^{2\pi} \int_0^\frac{\pi}{2} L_i(p,\theta_i,\phi_i)cos(\theta_i)sin(\theta_i) d\theta_i d\phi_i
```
如果使用切线空间（极坐标下）,法向量会与z轴对齐 $`n ⋅ \omega_i = cos\theta_i`$，用TBN矩阵转换到局部坐标或世界坐标角度$`\theta_i`$不变。  
我们再使用蒙特卡洛法近似：
```math
L_0(p,\theta_o,\phi_o) = \frac{\rho}{\pi} \frac{2\pi}{N_1}\frac{\pi}{2N_2}\sum^{N_1} \sum^{N_2} L_i(p,\theta_i,\phi_i)cos(\theta_i)sin(\theta_i) 
```
>这里假设表面粗糙尺度小于次表面散射距离(比较光滑)
### 镜面反射部分
- Cook-Torrance BRDF(镜面反射部分)： $`f_{cook-torrance} = \frac{D⋅ F⋅ G}{4(\omega_o ⋅ n)(\omega_i ⋅ n)} `$

1. D表示法线概率密度分布函数用于描述片段点法线朝向半程向量的概率密度(近似法线为半程向量的微平面面积/宏观表面面积比值)，要求满足从任意观察方向可见微平面区域总面积(所有法线朝向的微平面可见积分)等于宏观表面可见面积即：
```math
v⋅n = \int_\Theta D(m)(v⋅m)d\omega_m
```
或者
```math
v⋅n = \int_\Theta G_1(v,\omega_h) D(m) max(0,v⋅\omega_h)d\omega_h
```
>[!tip]
>第一个函数余弦因子未作截断处理——背向表面贡献负值，这样就把遮挡的面积抵消掉了，前提是假设表面为高度场(流形)  
>假设v = n $$1 = \int_\Theta D(m)(n⋅m)d\omega_m$$  
>我们现在仅讨论微平面法线朝正半球n⋅m>=0

**以下是几种常见的NDF**
- Blinn-Phone NDF:
$`D_p(m) = \frac{\alpha_p + 2}{2\pi}(n⋅m)^{\alpha_p}`$
>这里有个技巧将粗糙度映射到指数函数上进行调节$`\alpha_p = m^s`$(m是粗糙度α的上限，指数函数前部分变化小后部分变化大),用户调节s[0-1]。

- Beckmann分布 NDF：
$`D_b(m) = \frac{1}{\pi \alpha^2_b(n⋅m)^4}e^{-(\frac{1-(n⋅m)^2}{\alpha^2_b(n⋅m)^2})}`$
>贝克曼分布的α参数等同于微几何表面斜率的均方根，当α超过1将产生高均方根微几何表面斜率的"超粗糙"表面——法线分布集中在水平方向形成环类似于有众多朝上的尖锐纤维构成的表面
- GGX分布 NDF：
$`\chi(x) = x > 0 ? 1 : 0`$
$`D(m,n,\alpha) =frac{\alpha^2 \chi(m ⋅ n)}{\pi ( (m⋅n)^2 \alpha^2 + (1-(m⋅n)^2) )^2} `$ 
>既能模拟均匀分布又能表现超粗糙表面，这里建议将粗糙度映射到二次函数上进行调节$`\alpha_tr = s^2`$,用户调节s[0-1]。

**GGX分布推导：**  
首先我们用表面高度场(曲面)z(x,y)描述表面，将每个点的梯度$`(s_x,s_y), s_x =\frac{\partial z}{\partial x}, s_y=\frac{\partial z}{\partial y}`$定义为微平面斜率,  
每个微平面斜率一一对应其法线：$`m = \frac{(-s_x,-s_y,1)}{\sqrt{s_x^2 + s_y^2 +1}}`$ ，然后我们根据斜率概率分布$`P(s_x,s_y) = \frac{\alpha^2}{\pi(1+\alpha^2 (s_x^2 + s_y^2))^2}`$ 推导法线概率分布,  
因为概率守恒$`D(m,n,\alpha)cos\theta d\omega = P(s_x,s_y)ds_xds_y`$，又因为$` m ⋅ n(0,0,1) = cos\theta = \frac{1}{\sqrt{s_x^2 + s_y^2 + 1}}`$ 设$`u=\sqrt{s_x^2 + s_y^2} = tan\theta`$,  
>微元变换：斜率空间转换为极坐标$`ds_x ds_y = u dud\phi`$ ，立体角微元转换为球面坐标$`d\omega = sin\theta d\theta d\phi = \frac{u}{(u^2 + 1)^{\frac{3}{2}}}dud\phi`$

概率守恒原式等于：$`D(m,n,\alpha)cos\theta = P(s_x,s_y) \frac{ds_x ds_y}{d\omega } = P(s_x,s_y) ⋅ cos^{-3}\theta`$,   
带入斜率分布：$`D(m,n,\alpha) = \frac{\alpha^2}{\pi cos^4\theta (1 + \alpha^2tan^2\theta)^2}`$

>坐标变换时，如果是一元或多元中只有一元变换，直接代换即可。  

>其中m是微平面法线,镜面反射微平面法线与半程向量相等因为只有相等该微平面才会贡献反射亮度,斜率统计模型来源椭球分布且各项同性-旋转对称(这里法线分布函数是假设可见微平面法线朝向不随观察方向改变，等同于微观几何高度和法线无统计相关性)。  

>不同NDF都是为了追求函数分布具有更窄的峰尖更长的尾迹。

2. F表示菲涅尔项,分s-偏振光和p-偏振光:
$` R_s = |\frac{n_1 cos\theta_i - n_2 cos\theta_t}{n_1 cos\theta_i + n_2 cos\theta_t}|^2`$ 
$` R_p = |\frac{n_1 cos\theta_t - n_2 cos\theta_i}{n_1 cos\theta_t + n_2 cos\theta_i}|^2`$ 
   - $n_1, n_2$:两种介质的折射率
   - $\theta_t, \theta_i$:入射角和折射角,折射率公式：$`n_1sin\theta_i = n_2sin\theta_t`$
   - 菲涅尔方程是麦克斯韦方程组的一个特例在远大于波长的光学平面上
   - 不同波长的光在金属介质中的传播速度不同，导致折射率（以及吸收系数）随波长变化，这种现象称为色散。根据菲涅尔方程，反射率与折射率和入射角密切相关。由于金属的折射率在可见光谱范围内变化显著，不同波长的光被反射的程度不同，从而产生特定的颜色。
- 菲涅尔项的一个Schlick近似：$`F = F_0 + (1 - F_0)(1 - N⋅V)^5`$，$`F_0`$是当光线垂直入射时的反射率，取决于两种介质的折射率计算公式：$`F_0 = (\frac{n_1 - n_2}{n_1 + n_2})^2`$，或参考现实物质的实测值(如下表)：

| 材料 | $`F_0`$(linear) | $`F_0`$(sRGB) | 颜色 |
| --- | --- | --- | --- |
| 水 | (0.02, 0.02, 0.02) | (0.15, 0.15, 0.15) | `rgb(38,38,38)` |
| 玻璃 | (0.03, 0.03, 0.03) | (0.21, 0.21, 0.21) | `rgb(54,54,54)` |
| 塑料 | (0.05, 0.05, 0.05) | (0.24, 0.24, 0.24) | `rgb(61,61,61)` |
| 红宝石 | (0.08, 0.08, 0.08) | (0.31, 0.31, 0.31) | `rgb(79,79,79)` |
| 钻石 | (0.17, 0.17, 0.17) | (0.45, 0.45, 0.45) | `rgb(115,115,115)` |
| 铁 | (0.56, 0.57, 0.58) | (0.77, 0.78, 0.78) | `rgb(196,199,199)` |
| 铜 | (0.95, 0.64, 0.54) | (0.98, 0.82, 0.76) | `rgb(250,209,194)` |
| 金 | (1.00, 0.71, 0.29) | (1.00, 0.86, 0.57) | `rgb(255,219,145)` |
| 铝 | (0.91, 0.92, 0.92) | (0.96, 0.96, 0.97) | `rgb(245,245,247)` |
| 银 | (0.95, 0.93, 0.88) | (0.98, 0.97, 0.95) | `rgb(250,247,242)` |
> N⋅V取绝对值会比钳制处理好

3. G代表几何遮挡函数:描述了由于粗糙性微平面相互遮挡导致光通量损失
>Smith 模型假设遮挡和掩盖是统计独立的，遮挡：反射光被其它微平面阻挡，阴影：入射光被其它微平面阻挡(但阴影部分任可能被其它区域的间接光照射并反射，这先不考虑这一点)，假设微平面高度分布和法线分布是独立的(这是有争议的，越粗糙倾斜角越大误差越大)
   
   - 在Smith模型中单方向函数:$`G(v,n) = \frac{\int_{m⋅v>0}D(m)\chi(m,v)(m⋅v)dm}{\int_{m⋅v>0}D(m)(m⋅v)dm} `$ 表示微平面法线为m成立时从观察方向v到达微平面时不被遮挡的条件概率
   - $`\chi(m,v)`$指示函数，值为 1 表示光线从 v 方向到达微平面 m 时不被遮挡，值为 0 表示被遮挡。  
**实际应用中的公式：**  
 $`G_1(\omega) = \frac{1}{1 + \frac{-1 + \sqrt{1+\alpha^2 tan^2\theta}}{2}}`$  
 $`G(I,v) = G_1(I)G_1(v)`$ 该函数假设从不同方向观察和照射的遮挡概率独立，但如果观察方向和照射方向趋同独立性将消失造成数据估计偏低  
**改进函数:**  
 $`G(\omega_o,\omega_i) = \frac{1}{1 + \frac{-1 + \sqrt{1+\alpha^2 tan^2\theta_o}}{2} + \frac{-1 + \sqrt{1+\alpha^2 tan^2\theta_i}}{2}}`$  

>微表面模型的局限性：遇到无法模拟的现象像透射需要修改或扩展模型，考虑显著波动光学效应(衍射，衍射，偏振)则用全波动光学模型
### 物理术语： 
复折射率：$`n = n_r + in_i`$实部表示介质对光速的影响，定义为真空光速比介质光速，虚部表示光在介质中被吸收的量   
辐射通量：$`\phi`$表示光源的功率，单位瓦特  
立体角：$`\omega`$表示三维的角度，微分$`d\omega = \frac{dA}{r^2} = sin\theta d\theta d\phi`$ (球坐标)  
辐射强度：$`I = \frac{d\phi}{d\omega}`$  <a name="Radiant-Intensity"></a>  
辐射亮度radiance：$`L = \frac{d^2\phi}{dAd\omega cos\theta}`$  ，辐射通量基于立体角和投影面积(有效接受/发射面积)的双重微分，且是与方向无关的固有属性  <a name="Radiance"></a>  
>人眼的视锥细胞分别对长，中，短波长敏感，感知具有一定波长范围并不是对特定波长感知例如红≈650 nm，绿≈550 nm，蓝≈450 nm，设备RGB也是具有一定带宽光谱分布，因此光的RGB三元组(三元组分量之间独立不存在串扰，荧光和磷光会发生串扰)是通过对连续光谱分布I(λ)加权(颜色匹配函数)积分得到，综合了整个可见光光谱光线

双向透射分布函数（BTDF）  
双向散射分布函数（BSDF）  
活性表面面积是那些既满足法线朝向条件（法线为h）又未被遮挡的微平面面积。  

### 依赖库说明&参考文献
本项目依赖以下库：  
GLFW: 用于创建窗口、处理输入和事件。需安装 GLFW 库，推荐版本为 3.3 或以上。  
GLAD: OpenGL 函数加载器，用于加载 OpenGL 函数指针。需根据目标 OpenGL 版本（建议 3.3 或以上）生成对应的 GLAD 源代码。  
stb_image.h: 轻量级图像加载库，用于加载纹理图像。使用单文件头文件 stb_image.h，无需额外安装。  
TIFF: 用于处理 TIFF 格式图像。需安装 libtiff 库，推荐使用最新稳定版本。   
Assimp: 开源模型导入库，用于加载多种 3D 模型格式。需安装 Assimp 库，推荐版本为 5.2 或以上。  

请确保在构建项目前正确安装和配置上述依赖库。

[本篇demo基于该教程制作](https://learnopengl.com/PBR/Theory)  
[如果你想系统性由浅入深学习PBR原理，这才是你应该阅读的](https://www.cnblogs.com/timlly/p/10631718.html#221-lambert1760%E5%B9%B4)
